generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id       String  @id @default(cuid())
  username String  @unique
  email    String? @unique
  password String
  points   Int     @default(0)

  contactNumber String?
  remarks       String?
  isActive      Boolean   @default(true)
  role          Role      @default(PLAYER)
  parentId      String?
  parent        Company?  @relation("CompanyChildren", fields: [parentId], references: [id])
  children      Company[] @relation("CompanyChildren")
  status        Status?   @default(ACTIVE)

  rechargePerm Boolean @default(false)
  withdrawPerm Boolean @default(false)
  agentProtect Boolean @default(false)

  lastLoggedIn DateTime?
  deletedAt    DateTime?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  CompanyActivity CompanyActivity[]
  Wallet          Wallet?
  Ledger          Ledger[]
  CompanyConfig   CompanyConfig?

  twoFactorEnabled Boolean          @default(false)
  twoFactorMethod  TwoFactorMethod?
  twoFactorSecret  String? // encrypted secret (for TOTP) - ciphertext
  twoFactorEmail   String? // email used specifically for 2FA if desired

  AuditLog AuditLog[]

  GameSessionsAsPlayer GameSession[]       @relation("PlayerGames")
  GameSessionsAsStore  GameSession[]       @relation("StoreGames")
  payment              Payment[]
  gamePlayers          GamePlayer[]
  twoFactorOTPs        TwoFactorOTP[]
  rememberedDevices    RememberedDevice[]
  twoFactorRecoveries  TwoFactorRecovery[]
  backupCodes          BackupCode[]
  supportTickets       SupportTicket[]

  @@map("companies")
}

model CompanyConfig {
  id              String          @id @default(cuid())
  companyId       String          @unique
  company         Company         @relation(fields: [companyId], references: [id])
  winRate         Float           @default(0.5) // expected win rate (0â€“1)
  commissionRate  Float           @default(0.0) // % for distributors/stores
  maxBetLimit     Decimal         @default(1000)
  minBetLimit     Decimal         @default(1)
  gameControlMode GameControlMode @default(FAIR)
  updatedAt       DateTime        @updatedAt
  createdAt       DateTime        @default(now())
}

model GameRoom {
  id       String       @id @default(cuid())
  gameType GameType
  status   GameStatus   @default(PENDING)
  players  GamePlayer[]
}

model GamePlayer {
  id         String   @id @default(cuid())
  playerId   String
  gameRoomId String
  role       String? // player role
  joinedAt   DateTime @default(now())

  player   Company  @relation(fields: [playerId], references: [id])
  gameRoom GameRoom @relation(fields: [gameRoomId], references: [id])
}

model GameSession {
  id        String     @id @default(cuid())
  gameType  GameType
  playerId  String
  player    Company    @relation("PlayerGames", fields: [playerId], references: [id])
  storeId   String?
  store     Company?   @relation("StoreGames", fields: [storeId], references: [id])
  betAmount Decimal
  winAmount Decimal?   @default(0)
  result    GameResult
  playedAt  DateTime   @default(now())
  ledgers   Ledger[]
}

model CompanyActivity {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  ip        String?
  device    Json?
  location  Json?
  createdAt DateTime @default(now())
}

model Wallet {
  id        String   @id @default(cuid())
  companyId String   @unique
  balance   Decimal  @default(0)
  company   Company  @relation(fields: [companyId], references: [id])
  ledgers   Ledger[]
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model Ledger {
  id            String       @id @default(cuid())
  companyId     String
  walletId      String
  paymentId     String?
  gameSessionId String?
  sourceId      String?
  sourceType    String?
  type          LedgerType
  amount        Decimal
  balance       Decimal
  remark        String?
  wallet        Wallet       @relation(fields: [walletId], references: [id])
  payment       Payment?     @relation(fields: [paymentId], references: [id])
  gameSession   GameSession? @relation(fields: [gameSessionId], references: [id])
  company       Company      @relation(fields: [companyId], references: [id])
  createdAt     DateTime     @default(now())
}

model Payment {
  id           String          @id @default(cuid())
  companyId    String
  amount       Decimal         @default(0)
  currency     String?
  topupBalance Decimal         @default(0)
  merchant     PaymentMerchant
  status       PaymentStatus   @default(PENDING)
  company      Company         @relation(fields: [companyId], references: [id])

  ledgers   Ledger[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?
  actor     Company? @relation(fields: [actorId], references: [id])
  action    String
  targetId  String?
  details   Json?
  createdAt DateTime @default(now())
}

model TwoFactorOTP {
  id        String   @id @default(cuid())
  companyId String
  codeHash  String // hashed OTP for fallback/email flow (if used)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model RememberedDevice {
  id        String   @id @default(cuid())
  companyId String
  deviceId  String // hashed device identifier
  expiresAt DateTime
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id])

  @@unique([companyId, deviceId])
}

model TwoFactorRecovery {
  id         String         @id @default(cuid())
  companyId  String
  tokenHash  String
  status     RecoveryStatus @default(PENDING)
  createdAt  DateTime       @default(now())
  reviewedAt DateTime?

  company Company @relation(fields: [companyId], references: [id])
}

model BackupCode {
  id        String   @id @default(cuid())
  companyId String
  codeHash  String
  redeemed  Boolean  @default(false)
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id])
}

model SupportTicket {
  id          String            @id @default(cuid())
  parentId    String?
  companyId   String
  subject     String
  description String
  priority    SupportTicketType
  status      TicketStatus      @default(OPEN)
  file        String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  parent         SupportTicket?  @relation("TicketThread", fields: [parentId], references: [id])
  company        Company         @relation(fields: [companyId], references: [id])
  supportTickets SupportTicket[] @relation("TicketThread")
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportTicketType {
  HIGH
  MEDIUM
  LOW
}

enum GameControlMode {
  FAIR
  CONTROLLED
}

enum LedgerType {
  RECHARGE
  WITHDRAW
  BET
  WIN
  COMMISSION
  ADJUSTMENT
}

enum Status {
  ACTIVE
  BLOCK
  INACTIVE
  DELETED
}

enum Role {
  ADMIN
  DISTRIBUTOR
  SUB_DISTRIBUTOR
  STORE
  PLAYER
}

enum GameStatus {
  PENDING
  STARTED
  ONGOING
  DELETED
}

enum GameType {
  BLACKJACK
  POKER
  ROULETTE
  OTHER
}

enum GameResult {
  WIN
  LOSS
  DRAW
  PENDING
  CANCELLED
}

enum PaymentMerchant {
  PAYPAL
  STRIPE
  ADMIN
}

enum PaymentStatus {
  PAID
  CANCELLED
  PENDING
  REFUNDED
}

enum TwoFactorMethod {
  EMAIL
  SMS
}

enum RecoveryStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}
