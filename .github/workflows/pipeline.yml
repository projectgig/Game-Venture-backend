name: Venture Automated Deployment Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

env:
  VENTURE_NODE_VERSION: "20"
  DOCKER_IMAGE: gigproject/venture-api

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.VENTURE_NODE_VERSION }}
          cache: yarn

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Prettier
        run: yarn prettier --write .

      - name: Run Linter
        run: yarn run lint

      - name: Type Check
        run: yarn run type-check

  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.VENTURE_DOCKERHUB_USERNAME }}
          password: ${{ secrets.VENTURE_DOCKERHUB_TOKEN }}

      - name: Set image tags
        id: tags
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "IMAGE_TAG=latest" >> $GITHUB_OUTPUT
            echo "DOCKERFILE=./Dockerfile.prod" >> $GITHUB_OUTPUT
          else
            echo "IMAGE_TAG=dev-latest" >> $GITHUB_OUTPUT
            echo "DOCKERFILE=./Dockerfile.dev" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        run: |
          IMAGE_TAG=${{ steps.tags.outputs.IMAGE_TAG }}
          DOCKERFILE=${{ steps.tags.outputs.DOCKERFILE }}

          # Build with commit SHA
          docker build -f $DOCKERFILE \
            -t ${{ env.DOCKER_IMAGE }}:${{ github.sha }} \
            -t ${{ env.DOCKER_IMAGE }}:$IMAGE_TAG \
            .

          # Push both tags
          docker push ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          docker push ${{ env.DOCKER_IMAGE }}:$IMAGE_TAG

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Copy Swarm files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VENTURE_HOST }}
          username: ${{ secrets.VENTURE_SSH_USERNAME }}
          key: ${{ secrets.VENTURE_SSH_KEY }}
          source: "swarm/staging/*,scripts/deploy-staging.sh"
          target: "/root/venture/"
          strip_components: 0

      - name: Deploy to Staging
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VENTURE_HOST }}
          username: ${{ secrets.VENTURE_SSH_USERNAME }}
          key: ${{ secrets.VENTURE_SSH_KEY }}
          script: |
            cd /root/venture

            # Make script executable
            chmod +x scripts/deploy-staging.sh

            # Set environment variables
            export STACK_NAME="venture-staging"
            export STACK_FILE="/root/venture/swarm/staging/stack.yml"
            export ENV_FILE="/root/venture/.env.staging"
            export IMAGE_TAG="dev-latest"
            export DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}"

            # Run deployment script
            ./scripts/deploy-staging.sh

      - name: Deployment Summary
        if: success()
        run: |
          echo "### Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.DOCKER_IMAGE }}:dev-latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://${{ secrets.VENTURE_HOST }}:5000" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Copy Swarm files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VENTURE_HOST }}
          username: ${{ secrets.VENTURE_SSH_USERNAME }}
          key: ${{ secrets.VENTURE_SSH_KEY }}
          source: "swarm/production/*,scripts/deploy-production.sh"
          target: "/root/venture/"
          strip_components: 0

      - name: Deploy to Production (Blue-Green)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VENTURE_HOST }}
          username: ${{ secrets.VENTURE_SSH_USERNAME }}
          key: ${{ secrets.VENTURE_SSH_KEY }}
          script: |
            cd /root/venture

            # Make script executable
            chmod +x scripts/deploy-production.sh

            # Set environment variables
            export STACK_FILE="/root/venture/swarm/production/stack.yml"
            export ENV_FILE="/root/venture/.env.production"
            export IMAGE_TAG="latest"
            export DOCKER_IMAGE="${{ env.DOCKER_IMAGE }}"

            # Run deployment script
            ./scripts/deploy-production.sh

      - name: Deployment Summary
        if: success()
        run: |
          echo "### Production Deployment Successful! " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: Blue-Green Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.DOCKER_IMAGE }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: http://${{ secrets.VENTURE_HOST }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Zero-downtime deployment completed!**" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, build-and-push, deploy-staging, deploy-production]
    if: failure()
    steps:
      - name: Failure Summary
        run: |
          echo "### âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for more details." >> $GITHUB_STEP_SUMMARY
