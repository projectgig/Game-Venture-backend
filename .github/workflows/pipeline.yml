name: CI/CD Pipeline for Venture API

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

env:
  VENTURE_NODE_VERSION: "20"
  VENTURE_IMAGE_NAME: gigproject/venture-api
  STAGING_PORT: 5000
  PROD_PORT: 8000

jobs:
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.VENTURE_NODE_VERSION }}
          cache: yarn
      - run: yarn install --frozen-lockfile
      - run: yarn prettier --write .
      - run: yarn run lint
      - run: yarn run type-check

  build-and-push:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.VENTURE_DOCKERHUB_USERNAME }}
          password: ${{ secrets.VENTURE_DOCKERHUB_TOKEN }}
      - name: Build and push Docker image
        run: |
          IMAGE_TAG=${{ github.ref == 'refs/heads/main' && 'latest' || 'dev-latest' }}
          docker build -f ${{ github.ref == 'refs/heads/dev' && './Dockerfile.dev' || './Dockerfile.prod' }} -t ${{ env.VENTURE_IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ env.VENTURE_IMAGE_NAME }}:${{ github.sha }}
          docker tag ${{ env.VENTURE_IMAGE_NAME }}:${{ github.sha }} ${{ env.VENTURE_IMAGE_NAME }}:$IMAGE_TAG
          docker push ${{ env.VENTURE_IMAGE_NAME }}:$IMAGE_TAG

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    steps:
      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VENTURE_HOST }}
          username: ${{ secrets.VENTURE_SSH_USERNAME }}
          key: ${{ secrets.VENTURE_SSH_KEY }}
          script: |
            set -e
            export IMAGE=${{ env.VENTURE_IMAGE_NAME }}:dev-latest
            export NETWORK=venture-staging-network
            export ENV_FILE=${{ secrets.VENTURE_ENV_STAGING }}
            export COMMIT_SHA=${{ github.sha }}

            # Check for .env file
            if [ ! -f "$ENV_FILE" ]; then
              echo ".env.development does not exist! Deployment aborted."
              exit 1
            fi

            # Append COMMIT_SHA to .env
            echo "COMMIT_SHA=$COMMIT_SHA" >> "$ENV_FILE"

            # Pull latest image
            docker pull $IMAGE

            # Remove old network if exists
            docker network rm $NETWORK 2>/dev/null || true
            docker network create $NETWORK 2>/dev/null || true

            # Start Redis
            docker run -d \
              --name venture-redis-staging \
              --network $NETWORK \
              -p 6379:6379 \
              --env-file "$ENV_FILE" \
              --user root \
              --restart unless-stopped \
              redis:7-alpine

            # Start new container
            docker run -d \
              --name venture-api-staging \
              --network $NETWORK \
              -p ${{ env.STAGING_PORT }}:${{ env.STAGING_PORT }} \
              --env-file "$ENV_FILE" \
              --user root \
              --restart unless-stopped \
              $IMAGE

            # Health check
            max_attempts=15
            attempt=1
            success=0
            while [ $attempt -le $max_attempts ]; do
              if curl -f -s http://localhost:${{ env.STAGING_PORT }}/api/health > /dev/null; then
                echo "Health check passed (attempt $attempt)"
                success=$((success + 1))
                if [ $success -ge 3 ]; then
                  echo "Health checks consistently passing"
                  break
                fi
              else
                success=0
                if [ $attempt -eq $max_attempts ]; then
                  echo "Health check failed after $max_attempts attempts, rolling back..."
                  docker stop venture-api-staging-$NEW_COLOR || true
                  docker rm venture-api-staging-$NEW_COLOR || true
                  exit 1
                fi
              fi
              echo "Health check attempt $attempt/$max_attempts (successes: $success/3)"
              sleep 5
              attempt=$((attempt + 1))
            done

            # Stop and remove old container
            docker stop venture-api-staging-$OLD_COLOR 2>/dev/null || true
            docker rm venture-api-staging-$OLD_COLOR 2>/dev/null || true

            # Clean up unused images
            docker image prune -f

            echo "Staging deployment completed successfully! Active container: venture-api-staging-$NEW_COLOR"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VENTURE_HOST }}
          username: ${{ secrets.VENTURE_SSH_USERNAME }}
          key: ${{ secrets.VENTURE_SSH_KEY }}
          script: |
            set -e
            export IMAGE=${{ env.VENTURE_IMAGE_NAME }}:latest
            export NETWORK=venture-prod-network
            export ENV_FILE=/root/venture/.env.production
            export COMMIT_SHA=${{ github.sha }}

            # Check for .env file
            if [ ! -f "$ENV_FILE" ]; then
              echo ".env.production does not exist! Deployment aborted."
              exit 1
            fi

            # Append COMMIT_SHA to .env
            echo "COMMIT_SHA=$COMMIT_SHA" >> "$ENV_FILE"

            # Pull latest image
            docker pull $IMAGE

            # Blue-Green Deployment Logic
            CURRENT_CONTAINER=$(docker ps -q --filter "name=venture-api-prod-blue" --filter "status=running")
            if [ -n "$CURRENT_CONTAINER" ]; then
              NEW_COLOR="green"
              OLD_COLOR="blue"
            else
              NEW_COLOR="blue"
              OLD_COLOR="green"
            fi

            echo "Deploying to $NEW_COLOR container..."

            # Remove old network if exists
            docker network rm $NETWORK 2>/dev/null || true
            docker network create $NETWORK 2>/dev/null || true

            # Start Redis
            docker run -d \
              --name venture-redis-prod \
              --network $NETWORK \
              -p 6379:6379 \
              --env-file "$ENV_FILE" \
              --user root \
              --restart unless-stopped \
              redis:7-alpine

            # Start Postgres
            docker run -d \
              --name venture-postgres-prod \
              --network $NETWORK \
              -p 5432:5432 \
              --env-file "$ENV_FILE" \
              --user root \
              --restart unless-stopped \
              postgres:16-alpine

            # Run database migrations
            docker run --rm \
              --network $NETWORK \
              --env-file "$ENV_FILE" \
              $IMAGE \
              npx prisma migrate deploy

            # Start new container
            docker run -d \
              --name venture-api-prod-$NEW_COLOR \
              --network $NETWORK \
              -p ${{ env.PROD_PORT }}:${{ env.PROD_PORT }} \
              --env-file "$ENV_FILE" \
              --user root \
              --restart unless-stopped \
              $IMAGE

            # Health check
            max_attempts=15
            attempt=1
            success=0
            while [ $attempt -le $max_attempts ]; do
              if curl -f -s http://localhost:${{ env.PROD_PORT }}/api/health > /dev/null; then
                echo "Health check passed (attempt $attempt)"
                success=$((success + 1))
                if [ $success -ge 3 ]; then
                  echo "Health checks consistently passing"
                  break
                fi
              else
                success=0
                if [ $attempt -eq $max_attempts ]; then
                  echo "Health check failed after $max_attempts attempts, rolling back..."
                  docker stop venture-api-prod-$NEW_COLOR || true
                  docker rm venture-api-prod-$NEW_COLOR || true
                  exit 1
                fi
              fi
              echo "Health check attempt $attempt/$max_attempts (successes: $success/3)"
              sleep 5
              attempt=$((attempt + 1))
            done

            # Stop and remove old container
            docker stop venture-api-prod-$OLD_COLOR 2>/dev/null || true
            docker rm venture-api-prod-$OLD_COLOR 2>/dev/null || true

            # Clean up unused images
            docker image prune -f

            echo "Production deployment completed successfully! Active container: venture-api-prod-$NEW_COLOR"
